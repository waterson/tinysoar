CFLAGS=/nologo /W3 /DWINDOWS
LINK=link

# for debugging the rule grammar
!ifdef YYDEBUG
CFLAGS=$(CFLAGS) /DYYDEBUG=1
!endif

!ifdef BUILD_OPT
CFLAGS=$(CFLAGS) /O1 /DNDEBUG /UDEBUG
LFLAGS=$(LFLAGS)
!else
CFLAGS=$(CFLAGS) /Zi /Od /UNDEBUG /DDEBUG /MDd
LFLAGS=$(LFLAGS) /debug
!endif

SHARED_OBJS = \
	ht.obj \
	debug.obj \
        $(NULL)        

RUNTIME_OBJS = \
	alloc.obj \
	agent.obj \
	rete.obj \
	wmem.obj \
        $(NULL)

PARSER_OBJS = \
        y.tab.obj \
        lex.yy.obj \
        symtab.obj \
        $(NULL)

TINYSOAR_OBJS = \
        tinysoar.obj \
        $(NULL)

all: rete-test.exe parser-test.exe tinysoar.dll

parser-test.exe: parser-test.obj $(PARSER_OBJS) $(SHARED_OBJS)
        $(LINK) $(LFLAGS) /nologo /out:$@ $**

parser-test.obj: parser-test.c parser.h config.h defs.h

y.tab.obj: y.tab.c

y.tab.c y.tab.h: rule.y
        bison --yacc --defines $**

lex.yy.c: rule.l
        flex $**

lex.yy.obj: lex.yy.c y.tab.h

rete-test.exe: 	rete-test.obj $(RUNTIME_OBJS) $(SHARED_OBJS)
        $(LINK) $(LFLAGS) /out:$@ $**

rete-test.obj: rete-test.c soar.h alloc.h config.h defs.h


TCL_DIR=c:\tcl

TINYSOAR_LIBS=$(TCL_DIR)\lib\tcl83.lib

tinysoar.dll: $(TINYSOAR_OBJS) $(PARSER_OBJS) $(RUNTIME_OBJS) $(SHARED_OBJS)
        $(LINK) $(LFLAGS) $(TINYSOAR_LIBS) /dll /out:$@ $**

tinysoar.obj: tinysoar.c
        $(CC) /c $(CFLAGS) /I$(TCL_DIR)\include $**

alloc.obj: alloc.c alloc.h config.h defs.h
agent.obj: agent.c soar.h alloc.h config.h defs.h
ht.obj: ht.c ht.h alloc.h config.h defs.h
rete.obj: rete.c soar.h alloc.h config.h defs.h
runtime.obj: runtime.c config.h defs.h
symtab.obj: symtab.c soar.h config.h defs.h
wmem.obj: wmem.c soar.h ht.h alloc.h config.h defs.h

defs.h:
        echo /* Generated by makefile.win */ > $@
        echo #define inline __inline >> $@
        echo #define HAVE_MALLOC_H 1 >> $@
        echo #define SIZEOF_INT 4 >> $@

clean:
        -del *.obj *.exe *.lib *.pdb *.ilk rule.output y.tab.* lex.yy.c *~

distclean: clean
	-del defs.h

