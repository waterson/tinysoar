LEX = @LEX@
YACC = @YACC@
CFLAGS = @CFLAGS@ -Wall @DEFS@ -I@srcdir@ -I.

ifdef BUILD_OPT
# Optimized
CFLAGS += -O -UDEBUG -DNDEBUG
else
# Debug
CFLAGS += -g -DDEBUG -UNDEBUG
endif

MDDEPDIR=.deps

srcdir=@srcdir@
VPATH=@srcdir@

.c.o:
	$(CC) -c $(CFLAGS) -Wp,-MD,$(MDDEPDIR)/$*.pp -o $@ $<

all: $(MDDEPDIR) rete-test

MDDEPFILES := $(wildcard $(MDDEPDIR)/*.pp)

$(MDDEPDIR):
	mkdir $@

ifdef MDDEPFILES
include $(MDDEPFILES)
endif

SHARED_OBJS = \
	ht.o \
	debug.o \
	$(NULL)

RUNTIME_OBJS = \
	alloc.o \
	agent.o \
	rete.o \
	wmem.o \
	$(NULL)

PARSER_OBJS = \
	y.tab.o \
	lex.yy.o \
	symtab.o \
	$(NULL)

TINYSOAR_OBJS = \
	tinysoar.o \
	$(NULL)

all: rete-test parser-test tinysoar.so

rete-test: rete-test.c $(RUNTIME_OBJS) $(SHARED_OBJS)

parser-test: parser-test.c $(PARSER_OBJS) $(SHARED_OBJS)

y.tab.c: rule.y
	$(YACC) -d rule.y

lex.yy.c: rule.l
	$(LEX) rule.l

tinysoar.so: $(TINYSOAR_OBJS) $(PARSER_OBJS) $(RUNTIME_OBJS) $(SHARED_OBJS)
	$(CC) -shared -o $@ $^ -ltcl

clean:
	rm -rf .deps rete-test parser-test tinysoar.so y.tab.* lex.yy.c *.o core *~

distclean: clean
	rm -f Makefile config.cache config.log config.status defs.h

